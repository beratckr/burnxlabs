---
---

<div id="waitlist" class="bg-white rounded-2xl p-8 shadow-sm border border-gray-200 max-w-md mx-auto">
    <!-- Form Container -->
    <div id="form-container" class="transition-all duration-500">
        <form 
            id="waitlist-form"
            name="burnx-waitlist"
            method="POST"
            data-netlify="true"
            data-netlify-honeypot="bot-field"
            class="space-y-4"
        >
            <!-- Required hidden field for Netlify Forms -->
            <input type="hidden" name="form-name" value="burnx-waitlist" />
            
            <!-- Honeypot field for spam protection -->
            <p class="hidden">
                <label>
                    Don't fill this out if you're human: 
                    <input name="bot-field" />
                </label>
            </p>
            
            <div>
                <input 
                    type="email" 
                    id="email-input"
                    name="email"
                    placeholder="Enter your email" 
                    required
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-900 transition-colors"
                />
                <p id="email-error" class="hidden text-red-500 text-sm mt-1">Please enter a valid email address</p>
            </div>
            
            <input 
                type="text"
                id="firstName-input" 
                name="firstName"
                placeholder="First name (optional)" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-gray-900 transition-colors"
            />
            
            <button 
                type="submit"
                id="submit-btn"
                class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700 transition-all transform hover:scale-[1.02] active:scale-[0.98]"
            >
                <span id="btn-text">Join the waitlist</span>
                <span id="btn-loader" class="hidden">
                    <svg class="animate-spin h-5 w-5 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
        </form>
        
        <p class="text-sm text-gray-500 mt-4">
            Get early access and launch updates. No spam, unsubscribe anytime.
        </p>
    </div>

    <!-- Success Container (Initially Hidden) -->
    <div id="success-container" class="hidden opacity-0 transition-all duration-500">
        <div class="text-center">
            <!-- Success Icon -->
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-success-icon">
                <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            
            <!-- Success Message -->
            <h3 class="text-2xl font-bold text-gray-900 mb-2">You're on the list! ðŸŽ‰</h3>
            <p class="text-gray-600 mb-1">
                We've added <span id="user-email" class="font-medium text-purple-600"></span> to our waitlist.
            </p>
            <p class="text-gray-600 mb-6">
                You'll be the first to know when BurnX launches!
            </p>
            
            <!-- Next Actions -->
            <div class="mt-6">
                <!-- Add Another Email -->
                <button 
                    id="add-another-btn"
                    class="text-sm text-purple-600 hover:text-purple-700 font-medium transition-colors"
                >
                    + Add another email
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes success-icon {
        0% {
            transform: scale(0) rotate(-45deg);
            opacity: 0;
        }
        50% {
            transform: scale(1.1) rotate(5deg);
        }
        100% {
            transform: scale(1) rotate(0deg);
            opacity: 1;
        }
    }
    
    .animate-success-icon {
        animation: success-icon 0.6s ease-out;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }
    
    .animate-shake {
        animation: shake 0.5s ease-in-out;
    }
</style>

<script>
    const form = document.getElementById('waitlist-form') as HTMLFormElement;
    const formContainer = document.getElementById('form-container');
    const successContainer = document.getElementById('success-container');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = document.getElementById('btn-text');
    const btnLoader = document.getElementById('btn-loader');
    const userEmailSpan = document.getElementById('user-email');
    const addAnotherBtn = document.getElementById('add-another-btn');
    const emailInput = document.getElementById('email-input') as HTMLInputElement;
    const firstNameInput = document.getElementById('firstName-input') as HTMLInputElement;
    const emailError = document.getElementById('email-error');
    
    // Rate limiting and spam protection
    const RATE_LIMIT_KEY = 'waitlist_rate_limit';
    const SUBMISSION_COOLDOWN = 60000; // 1 minute between submissions
    const MAX_SUBMISSIONS_PER_DAY = 5; // Max 5 submissions per day per device
    
    // Email validation function
    function validateEmail(email: string): boolean {
        // More comprehensive email validation regex
        const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
        return emailRegex.test(email);
    }
    
    // Check for suspicious patterns
    function isSuspiciousEmail(email: string): boolean {
        // Block disposable email domains
        const disposableDomains = [
            'tempmail.com', 'throwaway.email', '10minutemail.com', 
            'guerrillamail.com', 'mailinator.com', 'temp-mail.org',
            'yopmail.com', 'trash-mail.com', 'sharklasers.com'
        ];
        
        const parts = email.split('@');
        if (parts.length !== 2) return true; // Invalid email format
        
        const domain = parts[1].toLowerCase();
        if (disposableDomains.some(function(d) { return domain.includes(d); })) {
            return true;
        }
        
        // Block emails with too many numbers (often spam)
        const numbersInLocal = (email.split('@')[0].match(/\d/g) || []).length;
        if (numbersInLocal > 4) {
            return true;
        }
        
        // Block emails with suspicious patterns
        const suspiciousPatterns = /test|spam|fake|dummy|example\.com/i;
        if (suspiciousPatterns.test(email)) {
            return true;
        }
        
        return false;
    }
    
    // Rate limiting check
    function checkRateLimit(): { allowed: boolean; message?: string } {
        const now = Date.now();
        const rateData = JSON.parse(localStorage.getItem(RATE_LIMIT_KEY) || '{}');
        
        // Check last submission time
        if (rateData.lastSubmission) {
            const timeSinceLastSubmission = now - rateData.lastSubmission;
            if (timeSinceLastSubmission < SUBMISSION_COOLDOWN) {
                const waitTime = Math.ceil((SUBMISSION_COOLDOWN - timeSinceLastSubmission) / 1000);
                return { 
                    allowed: false, 
                    message: `Please wait ${waitTime} seconds before submitting again.` 
                };
            }
        }
        
        // Check daily limit
        const today = new Date().toDateString();
        if (rateData.date !== today) {
            // Reset for new day
            rateData.date = today;
            rateData.count = 0;
        }
        
        if (rateData.count >= MAX_SUBMISSIONS_PER_DAY) {
            return { 
                allowed: false, 
                message: 'Daily submission limit reached. Please try again tomorrow.' 
            };
        }
        
        return { allowed: true };
    }
    
    // Update rate limit data
    function updateRateLimit() {
        const now = Date.now();
        const today = new Date().toDateString();
        const rateData = JSON.parse(localStorage.getItem(RATE_LIMIT_KEY) || '{}');
        
        if (rateData.date !== today) {
            rateData.date = today;
            rateData.count = 0;
        }
        
        rateData.lastSubmission = now;
        rateData.count = (rateData.count || 0) + 1;
        
        localStorage.setItem(RATE_LIMIT_KEY, JSON.stringify(rateData));
    }
    
    // Real-time email validation
    emailInput?.addEventListener('blur', () => {
        const email = emailInput.value.trim();
        if (email && !validateEmail(email)) {
            emailError?.classList.remove('hidden');
            emailInput.classList.add('border-red-500');
            emailInput.classList.remove('border-gray-300');
        } else {
            emailError?.classList.add('hidden');
            emailInput.classList.remove('border-red-500');
            emailInput.classList.add('border-gray-300');
        }
    });
    
    // Clear error on input
    emailInput?.addEventListener('input', () => {
        if (emailError && !emailError.classList.contains('hidden')) {
            emailError.classList.add('hidden');
            emailError.textContent = 'Please enter a valid email address'; // Reset to default message
            emailInput.classList.remove('border-red-500');
            emailInput.classList.add('border-gray-300');
        }
    });
    
    // Handle form submission
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Get form data
        const formData = new FormData(form);
        const email = (formData.get('email') as string).trim();
        const firstName = formData.get('firstName') as string;
        
        // Check rate limiting first
        const rateCheck = checkRateLimit();
        if (!rateCheck.allowed) {
            alert(rateCheck.message);
            return;
        }
        
        // Validate email format
        if (!validateEmail(email)) {
            emailError?.classList.remove('hidden');
            emailInput?.classList.add('border-red-500');
            emailInput?.classList.remove('border-gray-300');
            emailInput?.focus();
            
            // Shake animation for the input
            emailInput?.classList.add('animate-shake');
            setTimeout(() => {
                emailInput?.classList.remove('animate-shake');
            }, 500);
            
            return; // Exit early if email is invalid
        }
        
        // Check for suspicious email patterns
        if (isSuspiciousEmail(email)) {
            emailError?.textContent = 'Please use a valid email address (no temporary emails)';
            emailError?.classList.remove('hidden');
            emailInput?.classList.add('border-red-500');
            emailInput?.focus();
            return;
        }
        
        // Check if email already exists in localStorage
        const submissions = JSON.parse(localStorage.getItem('waitlist_submissions') || '[]');
        const existingSubmission = submissions.find((sub: any) => sub.email.toLowerCase() === email.toLowerCase());
        
        if (existingSubmission) {
            // Email already exists - show different message
            const successTitle = document.querySelector('#success-container h3');
            const successDesc = document.querySelector('#success-container p:nth-of-type(2)');
            
            if (successTitle) {
                successTitle.textContent = 'You\'re already on the list! ðŸ‘‹';
            }
            if (successDesc) {
                successDesc.textContent = 'We have your email and you\'ll be among the first to know when BurnX launches!';
            }
            
            // Show user's email
            if (userEmailSpan) {
                userEmailSpan.textContent = email;
            }
            
            // Animate transition directly without API call
            formContainer?.classList.add('opacity-0', 'scale-95');
            
            setTimeout(() => {
                formContainer?.classList.add('hidden');
                successContainer?.classList.remove('hidden');
                
                setTimeout(() => {
                    successContainer?.classList.remove('opacity-0');
                    successContainer?.classList.add('opacity-100', 'scale-100');
                }, 50);
            }, 300);
            
            return; // Exit early, no need to submit again
        }
        
        // Show loading state for new submissions
        btnText?.classList.add('hidden');
        btnLoader?.classList.remove('hidden');
        submitBtn?.setAttribute('disabled', 'true');
        
        try {
            // Submit to Netlify Forms
            const response = await fetch('/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams(formData as any).toString()
            });
            
            if (response.ok) {
                // Reset success message to default for new submissions
                const successTitle = document.querySelector('#success-container h3');
                const successDesc = document.querySelector('#success-container p:nth-of-type(2)');
                
                if (successTitle) {
                    successTitle.textContent = 'You\'re on the list! ðŸŽ‰';
                }
                if (successDesc) {
                    successDesc.textContent = 'You\'ll be the first to know when BurnX launches!';
                }
                
                // Show user's email in success message
                if (userEmailSpan) {
                    userEmailSpan.textContent = email;
                }
                
                // Animate transition
                setTimeout(() => {
                    // Fade out form
                    formContainer?.classList.add('opacity-0', 'scale-95');
                    
                    setTimeout(() => {
                        // Hide form and show success
                        formContainer?.classList.add('hidden');
                        successContainer?.classList.remove('hidden');
                        
                        // Fade in success
                        setTimeout(() => {
                            successContainer?.classList.remove('opacity-0');
                            successContainer?.classList.add('opacity-100', 'scale-100');
                        }, 50);
                    }, 300);
                }, 500);
                
                // Store submission in localStorage to prevent duplicates
                submissions.push({ email, firstName, timestamp: new Date().toISOString() });
                localStorage.setItem('waitlist_submissions', JSON.stringify(submissions));
                
                // Update rate limiting
                updateRateLimit();
                
            } else {
                throw new Error('Submission failed');
            }
        } catch (error) {
            console.error('Form submission error:', error);
            // Reset button state
            btnText?.classList.remove('hidden');
            btnLoader?.classList.add('hidden');
            submitBtn?.removeAttribute('disabled');
            
            // Show error (you could make this more elegant)
            alert('Something went wrong. Please try again or contact support.');
        }
    });
    
    // Handle "Add another email" button
    addAnotherBtn?.addEventListener('click', () => {
        // Reset form
        form.reset();
        
        // Animate transition back to form
        successContainer?.classList.remove('opacity-100', 'scale-100');
        successContainer?.classList.add('opacity-0', 'scale-95');
        
        setTimeout(() => {
            successContainer?.classList.add('hidden');
            formContainer?.classList.remove('hidden');
            
            // Reset button state
            btnText?.classList.remove('hidden');
            btnLoader?.classList.add('hidden');
            submitBtn?.removeAttribute('disabled');
            
            setTimeout(() => {
                formContainer?.classList.remove('opacity-0', 'scale-95');
                formContainer?.classList.add('opacity-100', 'scale-100');
                
                // Focus on email input
                emailInput?.focus();
            }, 50);
        }, 300);
    });
    
    // Check if user has already submitted
    document.addEventListener('DOMContentLoaded', () => {
        const submissions = JSON.parse(localStorage.getItem('waitlist_submissions') || '[]');
        if (submissions.length > 0) {
            // Could show a different message for returning users
            console.log('User has already joined waitlist:', submissions);
        }
    });
</script>